<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>Action with MV3</title>
  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
  <script type="text/javascript" src="/tests/SimpleTest/ExtensionTestUtils.js"></script>
  <script type="text/javascript" src="head.js"></script>
  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css">
</head>
<body>

<script type="text/javascript">
"use strict";

add_task(async function test_action_onClicked() {
  const extension = ExtensionTestUtils.loadExtension({
    manifest: {
      manifest_version: 3,
      action: {},
    },
    background() {
      browser.action.onClicked.addListener(async () => {
        browser.test.notifyPass("action-clicked");
      });

      browser.test.sendMessage("background-ready");
    },
  });

  await extension.startup();
  await extension.awaitMessage("background-ready");

  await AppTestDelegate.clickBrowserAction(window, extension);
  await extension.awaitFinish("action-clicked");
  await AppTestDelegate.closeBrowserAction(window, extension);

  await extension.unload();
});

add_task(async function test_action_isEnabled() {
  const extension = ExtensionTestUtils.loadExtension({
    manifest: {
      manifest_version: 3,
      action: {},
    },
    async background() {
      browser.test.assertTrue(
        await browser.action.isEnabled(),
        "action.isEnabled() true by default"
      );

      const [tab] = await browser.tabs.query({
        active: true,
        currentWindow: true,
      });
      browser.test.assertTrue(
        await browser.action.isEnabled(tab.id),
        "action.isEnabled(tabId) returns true by default"
      );
      await browser.action.disable(tab.id);

      browser.test.assertTrue(
        await browser.action.isEnabled(),
        "action.isEnabled() still true despite disable() for tab"
      );

      // isEnabled with integer tabId signature:
      browser.test.assertFalse(
        await browser.action.isEnabled(tab.id),
        "action.isEnabled(tabId) matches disable(tabId) call"
      );
      browser.test.assertThrows(
        () => browser.action.isEnabled(-1),
        "Type error for parameter details (Value -1 must either: be an object value, or be at least 0) for action.isEnabled.",
        "action.isEnabled(tabId) requires a valid tabId"
      );

      // isEnabled with object details signature:
      browser.test.assertFalse(
        await browser.action.isEnabled({ tabId: tab.id }),
        "action.isEnabled({ tabId }) matches disable(tabId) call"
      );

      await browser.action.disable();
      browser.test.assertFalse(
        await browser.action.isEnabled(),
        "action.isEnabled() returns false after disabling globally"
      );

      browser.test.sendMessage("done");
    },
  });

  await extension.startup();
  await extension.awaitMessage("done");
  await extension.unload();
});

</script>

</body>
</html>
